<!DOCTYPE html>
<html>
<head>
    <title></title>

    <script src="../libs/jquery-1.10.1.js"></script>
    <script src="../libs/jquery.xdomainajax.js"></script>
    <script src="../libs/d3.v3.min.js"></script>
    <script src="../libs/FileSaver.js"></script>
</head>
<body>

<script>
    var convertToInt;
    var lines=[];

    var gameIds = ['gameid,date_time,away_id,away_score,home_id,home_score'];

  var baseUrl = 'http://espn.go.com/mens-college-basketball/team/schedule/_/id/';
  var endUrl = '/year/2013';

  var gameidUrl = 'http://espn.go.com/ncb/recap?gameId=';

  var getMoreStats = function(gameid) {
    $.ajax({
      url: gameidUrl + gameid,
      async: false,
      type: 'GET',
      success: function(data) {

        console.log(gameid);
        outputStr = "";
        $away_id = $(data.responseText).find('div.away h3 a').attr('href');
        $away_id = $away_id.split('/id/').pop();
        $away_id = $away_id.split('/').shift();
        $away_score = $(data.responseText).find('div.away span').text();

        $home_id = $(data.responseText).find('div.home h3 a').attr('href');
        $home_id = $home_id.split('/id/').pop();
        $home_id = $home_id.split('/').shift();
        $home_score = $(data.responseText).find('div.home span').text();

        $date_time = $(data.responseText).find('div.game-time-location p:eq(0)').text();
        var format = d3.time.format("%-I:%M %p ET, %B %-d, %Y");
        $date_time = format.parse($date_time);

        outputStr = gameid + "," + $date_time + "," + $away_id + "," + $away_score + "," + $home_id + "," + $home_score;
        gameIds.push(outputStr);
      }
    })
  }

  var getGameIdList = function(teamId) {
      $.ajax({
        url: baseUrl + teamId + endUrl,
        async: false,
        type: 'GET',
        success: function(data, textStatus) {
          
          gameIds = ['gameid'];

          // grab all the game ids
          $(data.responseText).find('li.score a').each(function(i) {
            gameIds.push($(this).attr('href').split('=').pop());
          });

          saveCsvToFile(gameIds, teamId + '.csv');
        } // end success 
      }); // end $.ajax()
  };

    var saveCsvToFile = function(arrayOfLines, fileName) {
      /* adds linebreaks at the end*/
      var blob, blobText;
      blobText = arrayOfLines.map(function(d) {
        if (d.endsWith("\n")) {
          return d;
        } else {
          return d + "\n";
        }
      });
      blob = new Blob(blobText, {
        type: "text/plain;charset=utf-8"
      });
      return saveAs(blob, fileName);
    };

/*    $.ajax({
        url: "http://espn.go.com/mens-college-basketball/team/_/id/2619",
        type: 'GET',
        async: false,
        cache: false,
        success: function(data) {
          $trs = $(data.responseText).find('div.mod-table table.tablehead tr');

          var theString = "";
          //console.log($trs);
          console.log($trs.length);

			
			saveToFile(lines,"2012-13-teams-conferences.csv")
        },
        error: function() {
            return console.log("error");
        }
    });*/

    convertToInt = function(s) {
        return parseInt(s.replace(/,/g, ""), 10);
    };
	
    /* takes an array of strings
       and writes them line by line into a file given by filename
     */
    var saveToFile = function(arrayOfLines, fileName) {
       /* adds linebreaks at the end*/
       var blob, blobText;
       blobText = arrayOfLines.map(function(d) {
         if (d.endsWith("\n")) {
           return d;
         } else {
           return d + "\n";
         }
       });
       blob = new Blob(blobText, {
         type: "text/plain;charset=utf-8"
       });
       return saveAs(blob, fileName);
     };

     String.prototype.endsWith = function(suffix) {
       return this.indexOf(suffix, this.length - suffix.length) !== -1;
     };
	

    /*d3.csv('../data/new-master-id.csv', function(error, data) {

      data.forEach(function(d) {
        //console.log(d.espn_id);
        getGameIdList(d.espn_id);
      })
    })*/
var dataset;
    d3.csv('../data/all-gameids-2012-13.csv', function(error, data) {
      dataset = data;


      //saveCsvToFile(gameIds, "all-gameids-2012-13.csv");
    })

function runIt(start, end) {
  for (var i=start;i<end;i++) {
    d = dataset[i];
    getMoreStats(d.gameid);
  }
}

</script>


</body>
</html>