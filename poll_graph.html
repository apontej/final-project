<html>
<head>
<script src="libs/d3.v3.min.js"></script>
<script src="scripts/teamcolors.js"></script>
<script src="libs/jquery-1.10.1.js"></script>
<script src="scripts/master-ids-load.js"></script>
<script src="libs/d3.slider.js"></script>
<link rel="stylesheet" href="libs/d3.slider.css" />
</head>
<body>
<table>
<!-- <tr>
<td> -->
<!-- <form>
<label><input type="radio" name="pollSelect" value="ap" onClick='displayPoll("ap")'> Associated Press</label>
<label><input type="radio" name="pollSelect" value="coaches" onClick='displayPoll("coaches")'/> Coaches/USA Today</label>
</form> -->
<!-- </td>
<td></td>
</tr> -->
<tr>
<td>
<form>
<label><input type="radio" name="pollSelect" value="ap" onClick='displayPoll("ap")'> Associated Press</label>
<label><input type="radio" name="pollSelect" value="coaches" onClick='displayPoll("coaches")'/> Coaches/USA Today</label>
<label><input type="radio" name="pollSelect" value="rpi" onClick='displayPoll("rpi")'/> RPI</label>
</form>
<div id="pollgraph"></div></td>
<td><div id="confBar"></div></td>
</tr>
</table>
<script type="text/javascript">

var margin = {
	top:10,
	right:150,
	bottom:50,
	left:30
};

var width1 = 1000 - margin.left - margin.right;

var bbPoll = {
	x: margin.left,
	y: margin.top,
	w: width1,
	h: 600
}

var dataset;
var teams = {};
var teamlines = [];
var weeks = [];
var conferences = {};

origStroke = 3;
hoverStroke = 10;

// var svg = d3.select("body").append("svg");

var canvas = d3.select("#pollgraph").append("svg").attr({
	width: bbPoll.w + margin.left + margin.right,
	height: bbPoll.h + margin.top + margin.bottom
});

var svg = canvas.append("g").attr({
	transform: "translate(" + margin.left + "," + margin.top + ")"
});

var polls = { "ap": "data/poll-data/2012-13-AP.csv", "coaches": "data/poll-data/2012-13-coaches.csv", "rpi": "data/rpi-ratings/2012-13-rpi.csv" };

function displayPoll(thePoll) {
	thePollPath = polls[thePoll];

//d3.csv("data/poll-data/2012-13-AP.csv", function(error, data) {
d3.csv(thePollPath, function(error, data) {
	var teams = {};
var teamlines = [];
var weeks = [];
conferences = {};
	dataset = data;

	//d3.selectAll("path#teampath").exit().remove();
	//console.log(dataset);

	for (var i=0;i<dataset.length;i++) {
		if (dataset[i].Wk === "Wk") {
			dataset.splice(i,1);
		}
	}

	for (var i=0;i<dataset.length;i++) {
		/*if (dataset[i].School.indexOf("Gonzaga") !== -1) {
			console.log(dataset[i].Wk, dataset[i].Rk);

		}*/
		line = dataset[i];
		school = line.School;
		strWeek = line.Wk;
		week = parseInt(strWeek);
		line.Wk = week;
		rank = parseInt(line.Rk);
		line.Rk = rank;
		starIndex = school.indexOf("*");
		if (weeks.indexOf(line.Wk) === -1) {
			weeks.push(line.Wk);
		}
		if (starIndex > 0) {
			school = school.substring(0,starIndex);
			line.School = school;
		}
		if (teams[school]) {
			teams[school].push(line);
		} else {
			teams[school] = [line];
		}

		conf = line.Conf;
		if (conferences[conf]) {
			if (conferences[conf][week]) {
				conferences[conf][week]++;
			} else {
				conferences[conf][week] = 1;
			}
		} else {
			conferences[conf] = {};
			conferences[conf][week] = 1;
		}
	}

	for (var school in teams) {
		rankedWeeks = [];
		ranks = teams[school];
		ranks.forEach(function(d) {
			rankedWeeks.push(d.Wk);
		})
		if (rankedWeeks.length !== weeks.length) {
			var diff = [];
			var j=0;
			for (var i=0;i<weeks.length;i++) {
				if (rankedWeeks.indexOf(weeks[i]) === -1) {
					diff.push(weeks[i]);
				}
			}
			//console.log(school, diff);
			diff.forEach(function(d) {
				teams[school].push({"Wk": d, "Rk": "26"});
			})
		}
		ranks = teams[school];
		ranks.sort(function(a,b) {
			return d3.ascending(a.Wk, b.Wk);
		})
	}

	maxWk = d3.max(weeks, function(d) { return d; });

	//console.log(teams);

/*	xscale = d3.scale.linear().domain([1,maxWk]).range([50,1600]);
	yscale = d3.scale.linear().domain([1,25]).range([50,700]);*/

	xscale = d3.scale.linear().domain([1,maxWk]).range([bbPoll.x,bbPoll.w-100]);
	yscale = d3.scale.linear().domain([1,25]).range([bbPoll.y+20,bbPoll.h]);

	xaxis = d3.svg.axis()
				.scale(xscale)
				.orient("bottom")
				.ticks(20);

	yaxis = d3.svg.axis()
				.scale(yscale)
				.orient("left")
				.ticks(25);

	var teamline = d3.svg.line().x(function(d) { return xscale(d.Wk); })
								.y(function(d) { return yscale(d.Rk); })
								.interpolate("cardinal");

	//colorScale = d3.scale.linear().domain([1,25]).range(["red", "green"]);

	//svg = d3.select("svg").transition();

    svg.append("defs").append("clipPath")
        .attr("id", "clip")
        .append("rect")
        .attr("width", bbPoll.w)
        .attr("height", bbPoll.h-10)
        .attr("x", bbPoll.x)
        .attr("y", bbPoll.y);

	count = 1;

  svg
    .selectAll('.teampath')
    .remove();

  svg.selectAll(".teamtext")
  		.remove();

  svg.selectAll(".axis")
  		.remove();

	for (var school in teams) {

		svg.append("path")
			.attr("d", teamline(teams[school]))
			.classed(school, true)
			.classed("teampath", true)
			.style("fill", "none")
			.style("stroke-width", origStroke)
			.style("stroke", searchColor(school))
			.on("mouseover", function(d) {
				var thepath = d3.select(this);
				//thepath.style("stroke-width", hoverStroke);
				return highlightPath(thepath);
			})
			.on("mouseout", function(d) {
				//var thepath = d3.select(this);
				//thepath.style("stroke-width", origStroke);
				return backToNormal();
			})
			.style("clip-path", "url(#clip)")
		count++;

		lastRk = teams[school][teams[school].length-1].Rk;
		if (lastRk < 26) {
			svg.append("text")
				.classed("teamtext", true)
				.attr("transform", "translate("+(bbPoll.w-90)+","+yscale(lastRk)+")")
				.attr("dy", ".25em")
				.attr("text-anchor", "start")
				.style("fill", searchColor(school))
				.on("mouseover", function() {
					//thisSchool = this.indexOf
					theSchool = this.innerHTML;
					theSchool = theSchool.substring((theSchool.indexOf(" ")+1));
					//console.log(theSchool);
					return highlightPath(null,theSchool);
				})
				.on("mouseout", function() {
					return backToNormal();
				})
				.text(lastRk + ": " + school);
		}
	}


	svg.append("g")
		.attr("class", "axis")
		.attr("transform", "translate(0,600)")
		.call(xaxis);

	svg.append("g")
		.attr("class", "axis")
		.attr("transform", "translate("+margin.left+",0)")
		.call(yaxis);

/*	svg.append("path")
		.attr("d", teamline(teams["Gonzaga"]))
		.style("fill", "none")
		.style("stroke", "black");*/

	//console.log(dataset);
})
}

var allPaths;

function highlightPath(thePath,school) {

	d3.selectAll("path.teampath")
			.style("opacity", 0.25)
			.style("stroke-width", 1);

	if (thePath) {
		thePath.style("stroke-width", hoverStroke)
				.style("opacity", 1);
	}
	if (school) {
		thePath = d3.select("path."+school);
		thePath.style("stroke-width", hoverStroke)
				.style("opacity", 1);
	}
}

var confCanvas,chart;
var confXScale,confYScale,confXAxis,confXsvg;

function createConfBar() {
	confCanvas = d3.select("#confBar").append("svg").attr({
		width: 300,
		height: 300
	})

	chart = confCanvas.append("g").attr({
		transform: "translate(0,20)"
	});

	confXScale = d3.scale.ordinal().rangeRoundBands([0,300]);
	confYScale = d3.scale.linear().rangeRound([250,0]);

	confXAxis = d3.svg.axis()
					.scale(confXScale)
					.orient("bottom");

	confXsvg = chart.append("g")
					.attr("class", "axis")
					.attr("transform", "translate(0,250)");
}

var currConfs,confCounts;
function updateConfBar(week) {
	currConfs = [];
	confCounts = [];
	for (var conf in conferences) {
		if (conferences[conf][week]) {
			currConfs.push(conf);
			confCounts.push(conferences[conf][week]);
		}
	}


	confXScale.domain(currConfs);
	confXsvg.call(confXAxis)
		.selectAll("text")
			.style("font-size", "7pt");
	maxCount = d3.max(confCounts, function(d) { return d; });
	confYScale.domain([0,maxCount]);

	chart.selectAll("rect").remove();

	chart.selectAll("rect")
			.data(confCounts)
			.enter()
			.append("rect")
			.attr("class", "bars")
			.attr("height", function(d) { return (250-confYScale(d)); })
			.attr("width", ((300/confCounts.length)-2))
			.attr("transform", function(d,i) { return "translate(" + confXScale(currConfs[i]) + "," + confYScale(d) + ")"; });
}

function backToNormal() {
	d3.selectAll("path.teampath")
					.style("opacity", 1)
					.style("stroke-width", origStroke);
}

//d3.select("input[value=\"ap\"]").on("click", displayPoll("ap"));
//d3.select("input[value=\"coaches\"]").on("click", displayPoll("coaches"));

displayPoll("ap");

createConfBar();
d3.select("body").append("div").attr("class", "d3-slider d3-slider-horizontal")//.style("margin-left", "35px");
d3.select("div.d3-slider").call(d3.slider().axis(true).min(1).max(20).step(1).on("slide", function(evt, value) { updateConfBar(value); } ));
//displayPoll("coaches");

</script>

</body>
</html>
