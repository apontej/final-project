<html>
<head>
<script src="libs/d3.v3.min.js"></script>
<script src="scripts/teamcolors.js"></script>
<script src="libs/jquery-1.10.1.js"></script>
<script src="scripts/master-ids-load.js"></script>
<script src="libs/d3.slider.js"></script>
<script src="libs/d3.tip.v0.6.3.js"></script>
<link rel="stylesheet" href="libs/d3.slider.css" />
<style>
	.d3-tip {
		line-height:1;
		font-weight:bold;
		padding:12px;
		background: rgba(0,0,0,0.75);
		color:#fff;
		border-radius:5px;
	}

    .axis path,
    .axis line {
        fill: none;
        stroke: lightgrey; 
    	stroke-width: 2px;
    }

    .axis text {
        font-family: sans-serif;
        font-size: 9px;
    }
</style>
</head>
<body>
<table>
<!-- <tr>
<td> -->
<!-- <form>
<label><input type="radio" name="pollSelect" value="ap" onClick='displayPoll("ap")'> Associated Press</label>
<label><input type="radio" name="pollSelect" value="coaches" onClick='displayPoll("coaches")'/> Coaches/USA Today</label>
</form> -->
<!-- </td>
<td></td>
</tr> -->
<tr>
<td rowspan="2">
<form>
<label><input type="radio" name="pollSelect" value="ap" onClick='displayPoll("ap")' checked> Associated Press</label>
<label><input type="radio" name="pollSelect" value="coaches" onClick='displayPoll("coaches")'/> Coaches/USA Today</label>
<label><input type="radio" name="pollSelect" value="rpi" onClick='displayPoll("rpi")'/> RPI</label>
</form>
<div id="pollgraph"></div></td>
<td valign="top"><div id="confBar"></div></td>
</tr>
<tr>
<td valign="top"><div id="movers"></div></td>
</tr>
</table>
<script type="text/javascript">

var margin = {
	top:10,
	right:150,
	bottom:50,
	left:30
};

var width1 = 1000 - margin.left - margin.right;

var bbPoll = {
	x: margin.left,
	y: margin.top,
	w: width1,
	h: 600
}

var dataset;
var teams = {};
var teamlines = [];
var weeks = [];
var conferences = {};

origStroke = 3;
hoverStroke = 10;

// var svg = d3.select("body").append("svg");

var canvas = d3.select("#pollgraph").append("svg").attr({
	width: bbPoll.w + margin.left + margin.right,
	height: bbPoll.h + margin.top + margin.bottom
});

var svg = canvas.append("g").attr({
	transform: "translate(" + margin.left + "," + margin.top + ")"
});

var polls = { "ap": "data/poll-data/2012-13-AP.csv", "coaches": "data/poll-data/2012-13-coaches.csv", "rpi": "data/rpi-ratings/2012-13-rpi.csv" };

var tip = d3.tip()
			.attr("class", "d3-tip")
			.offset([-10,0])
			.html(function(d) {
				//console.log("d", d);
				return getIDsBy(d).friendly_school;
			})

svg.call(tip);

var externalschool;

var moversObj = {};

function displayPoll(thePoll) {
	thePollPath = polls[thePoll];

//d3.csv("data/poll-data/2012-13-AP.csv", function(error, data) {
d3.csv(thePollPath, function(error, data) {
	teams = {};
	teamlines = [];
	weeks = [];
	conferences = {};
	dataset = data;

	//d3.selectAll("path#teampath").exit().remove();
	//console.log(dataset);

	for (var i=0;i<dataset.length;i++) {
		if (dataset[i].Wk === "Wk") {
			dataset.splice(i,1);
		}
	}

	for (var i=0;i<dataset.length;i++) {
		/*if (dataset[i].School.indexOf("Gonzaga") !== -1) {
			console.log(dataset[i].Wk, dataset[i].Rk);

		}*/
		line = dataset[i];
		school = line.School;
		if (i == 4) externalschool = school;
		strWeek = line.Wk;
		week = parseInt(strWeek);
		line.Wk = week;
		rank = parseInt(line.Rk);
		line.Rk = rank;
		starIndex = school.indexOf("*");
		if (weeks.indexOf(line.Wk) === -1) {
			weeks.push(line.Wk);
		}
		if (starIndex > 0) {
			school = school.substring(0,starIndex);
			line.School = school;
		} else if (/\sR/g.test(school)) {
			if (!/\sR[a-z]/g.test(school)) {
				lastIndex = school.lastIndexOf("R");
				school = school.substring(0,lastIndex-1);
				line.School = school;
			}
		}
		if (teams[school]) {
			teams[school].push(line);
		} else {
			teams[school] = [line];
		}

		conf = line.Conf;
		if (conferences[conf]) {
			if (conferences[conf][week]) {
				conferences[conf][week]++;
			} else {
				conferences[conf][week] = 1;
			}
		} else {
			conferences[conf] = {};
			conferences[conf][week] = 1;
		}
	}



	for (var school in teams) {
		rankedWeeks = [];
		ranks = teams[school];
		ranks.forEach(function(d) {
			rankedWeeks.push(d.Wk);
		})
		if (rankedWeeks.length !== weeks.length) {
			var diff = [];
			var j=0;
			for (var i=0;i<weeks.length;i++) {
				if (rankedWeeks.indexOf(weeks[i]) === -1) {
					diff.push(weeks[i]);
				}
			}
			//console.log(school, diff);
			diff.forEach(function(d) {
				teams[school].push({"Wk": d, "Rk": "26"});
			})
		}
		ranks = teams[school];
		ranks.sort(function(a,b) {
			return d3.ascending(a.Wk, b.Wk);
		})
		// Build object with all rank changes keyed by week
		ranks.forEach(function(d, i) {
			if (i > 0) {
				change = ranks[i-1].Rk - ranks[i].Rk
				ranks[i].Chng = change;
				if (moversObj[d.Wk]) {
					moversObj[d.Wk].push({"School": school, "Change": change});
				} else {
					moversObj[d.Wk] = [{"School": school, "Change": change}];
				}
			}
		})
	}

	findTopMovers();

	maxWk = d3.max(weeks, function(d) { return d; });

	//console.log(teams);

/*	xscale = d3.scale.linear().domain([1,maxWk]).range([50,1600]);
	yscale = d3.scale.linear().domain([1,25]).range([50,700]);*/

	xscale = d3.scale.linear().domain([1,maxWk]).range([bbPoll.x,bbPoll.w-100]);
	yscale = d3.scale.linear().domain([1,25]).range([bbPoll.y+20,bbPoll.h]);

	xaxis = d3.svg.axis()
				.scale(xscale)
				.orient("bottom")
				.ticks(20);

	yaxis = d3.svg.axis()
				.scale(yscale)
				.orient("left")
				.ticks(25);

	var teamline = d3.svg.line().x(function(d) { return xscale(d.Wk); })
								.y(function(d) { return yscale(d.Rk); })
								.interpolate("cardinal");

	//colorScale = d3.scale.linear().domain([1,25]).range(["red", "green"]);

	//svg = d3.select("svg").transition();

    svg.append("defs").append("clipPath")
        .attr("id", "clip")
        .append("rect")
        .attr("width", bbPoll.w)
        .attr("height", bbPoll.h-10)
        .attr("x", bbPoll.x)
        .attr("y", bbPoll.y);

	count = 1;

  svg
    .selectAll('.teampath')
    .remove();

  svg.selectAll(".teamtext")
  		.remove();

  svg.selectAll(".axis")
  		.remove();

	for (var school in teams) {
		console.log(school);
		espnid = getIDsBy(undefined,undefined,undefined,school,undefined).espn_id;
		espnid = "x" + espnid.toString();
		console.log(espnid);

		//svg.append("path")
		svg.append("g").append("path")
			.attr("d", teamline(teams[school]))
			.classed(espnid, true)
			.classed("teampath", true)
			.style("fill", "none")
			.style("stroke-width", origStroke)
			.style("stroke", searchColor(school))
			.on("mouseover", function(d) {
				var thePath = d3.select(this);
				//thepath.style("stroke-width", hoverStroke);
				theClass = getClassFromPath(thePath);
				console.log(theClass);
				tip.show(theClass);
				return highlightPath(thePath);
			})
			.on("mouseout", function(d) {
				var thePath = d3.select(this);
				//thepath.style("stroke-width", origStroke);
				theClass = getClassFromPath(thePath);
				tip.hide(theClass);
				return backToNormal();
			})
			.style("clip-path", "url(#clip)")
		count++;

		lastRk = teams[school][teams[school].length-1].Rk;
		if (lastRk < 26) {
			svg.append("text")
				.classed("teamtext", true)
				.attr("transform", "translate("+(bbPoll.w-90)+","+yscale(lastRk)+")")
				.attr("dy", ".25em")
				.attr("text-anchor", "start")
				.style("fill", searchColor(school))
				.on("mouseover", function() {
					//thisSchool = this.indexOf
					theSchool = this.innerHTML;
					console.log(theSchool);
					theSchool = theSchool.substring((theSchool.indexOf(" ")+1));
					//console.log(theSchool);
					return highlightPath(null,theSchool);
				})
				.on("mouseout", function() {
					return backToNormal();
				})
				.text(lastRk + ": " + school);
		}
	}


	svg.append("g")
		.attr("class", "axis")
		.attr("transform", "translate(0,600)")
		.call(xaxis);

	svg.append("g")
		.attr("class", "axis")
		.attr("transform", "translate("+margin.left+",0)")
		.call(yaxis);

/*	svg.append("path")
		.attr("d", teamline(teams["Gonzaga"]))
		.style("fill", "none")
		.style("stroke", "black");*/

	//console.log(dataset);
})
}

var allPaths;

function getClassFromPath(thePath) {
	theClass = thePath[0][0].className.animVal;
	console.log(theClass);
	tpi = theClass.indexOf("teampath");
	theClass = theClass.substring(1,(tpi-1));
	console.log(theClass);
	return theClass;
}

function highlightPath(thePath,school) {

	d3.selectAll("path.teampath")
			.style("opacity", 0.25)
			.style("stroke-width", 1);

	if (thePath) {
		thePath.style("stroke-width", hoverStroke)
				.style("opacity", 1);
		// classes = thePath[0][0].className.animVal;
		// tpi = classes.indexOf("teampath");
		// classes = classes.substring(0,(tpi-1));
		// console.log(classes);
	}
	if (school) {
		school = getIDsBy(undefined,undefined,undefined,school,undefined).espn_id;
		school = "x" + school.toString();
		console.log(school);
		thePath = d3.select("path."+school);
		thePath.style("stroke-width", hoverStroke)
				.style("opacity", 1);
	}
}

var confCanvas,chart;
var confXScale,confYScale,confXAxis,confXsvg;

var topMovers = {};

function findTopMovers() {
	for (var week in moversObj) {
		changes = moversObj[week];
		changes.sort(function(a,b) {
			return d3.descending(Math.abs(a.Change), Math.abs(b.Change));
		})
		topM = changes.splice(0,7);
		topM.sort(function(a,b) {
			return d3.descending(a.Change, b.Change);
		})
		topMovers[week] = topM;
	}
}

var moversTable, moversThead, moversTbody, moversRows, moversColumns, moversCells;

function createMoversTable() {
	moversColumns = ["School", "Change"];
	var dummydata = [];
	for (var i=0;i<7;i++) {
		dummydata.push({"School": i, "Change": i});
	}

	moversTable = d3.select("#movers").append("table")
					.style("display", "none")
					.attr("width", "300px");

	moversThead = moversTable.append("thead");
	moversTbody = moversTable.append("tbody");

	moversThead.append("tr")
			.selectAll("th")
			.data(moversColumns)
			.enter()
			.append("th")
				.text(function(column) { return column; })
				.attr("align", function(d,i) { return i===0?"left":"right"; })
				.attr("width", function(d,i) { return i===0?"200px":"100px"; })

	moversRows = moversTbody.selectAll("tr")
				.data(dummydata)
				.enter()
				.append("tr");

	// moversCells = moversRows.selectAll("td")
	// 			.data(function(row) {
	// 				return moversColumns.map(function(column) {
	// 					return {column: column, value: row[column]};
	// 				})
	// 			})
	// 			.enter()
	// 			.append("td")
	// 				.html(function(d) { return d.value; })
	// 				.attr("align", function(d,i) { return i===0?"left":"right"; })

	return moversTable;
}

function updateMoversTable(week) {
	var moversData = topMovers[week];

	moversTable.style("display", "block");

	moversTbody.selectAll("tr").remove();

	moversRows = moversTbody.selectAll("tr")
				.data(moversData)
				.enter()
				.append("tr");

	moversCells = moversRows.selectAll("td")
				.data(function(row) {
					return moversColumns.map(function(column) {
						return {column: column, value: row[column]};
					})
				})
				.enter()
				.append("td")
					.html(function(d) { return d.value; })
					.attr("align", function(d,i) { return i===0?"left":"right"; })

}

function createConfBar() {
	confCanvas = d3.select("#confBar").append("svg").attr({
		width: 300,
		height: 300
	})

	chart = confCanvas.append("g").attr({
		transform: "translate(0,20)"
	});

	confXScale = d3.scale.ordinal().rangeRoundBands([0,300]);
	confYScale = d3.scale.linear().rangeRound([250,0]);

	confXAxis = d3.svg.axis()
					.scale(confXScale)
					.orient("bottom");

	confXsvg = chart.append("g")
					.attr("class", "axis")
					.attr("transform", "translate(0,250)");
}

var currConfs,confCounts;
function updateConfBar(week) {
	currConfs = [];
	confCounts = [];
	for (var conf in conferences) {
		if (conferences[conf][week]) {
			currConfs.push(conf);
			confCounts.push(conferences[conf][week]);
		}
	}


	confXScale.domain(currConfs);
	confXsvg.call(confXAxis)
		.selectAll("text")
			.style("font-size", "7pt");
	maxCount = d3.max(confCounts, function(d) { return d; });
	confYScale.domain([0,maxCount]);

	chart.selectAll("rect").remove();
	chart.selectAll(".barValue").remove();

	chart.selectAll("rect")
			.data(confCounts)
			.enter()
			.append("rect")
			.attr("class", "bars")
			.attr("fill", "lightsteelblue")
			.attr("height", function(d) { return (250-confYScale(d)); })
			.attr("width", ((300/confCounts.length)-2))
			.attr("transform", function(d,i) { return "translate(" + confXScale(currConfs[i]) + "," + confYScale(d) + ")"; });

	chart.selectAll(".barValue")
			.data(confCounts)
			.enter()
			.append("text")
			.text(function(d) {
				return d;
			})
			.attr("class", "barValue")
			.attr("text-anchor", "middle")
			.attr("x", function(d, i) {
				return i * (300 /confCounts.length) + (300 / confCounts.length - 2) /2;
			})
			.attr("y", function(d) {
				return (confYScale(d) + 24);
			});
}

function backToNormal() {
	d3.selectAll("path.teampath")
					.style("opacity", 1)
					.style("stroke-width", origStroke);
}

//d3.select("input[value=\"ap\"]").on("click", displayPoll("ap"));
//d3.select("input[value=\"coaches\"]").on("click", displayPoll("coaches"));

displayPoll("ap");

createConfBar();
createMoversTable();
d3.select("body").append("div").attr("class", "d3-slider d3-slider-horizontal")//.style("margin-left", "35px");
d3.select("div.d3-slider").call(d3.slider().axis(true).min(1).max(20).step(1).on("slide", function(evt, value) { updateConfBar(value); updateMoversTable(value); } ));
//displayPoll("coaches");

</script>

</body>
</html>
