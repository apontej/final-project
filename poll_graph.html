<html>
<head>
<script src="libs/d3.v3.min.js"></script>
<script src="scripts/teamcolors.js"></script>
<script src="libs/jquery-1.10.1.js"></script>
<script src="scripts/master-ids-load.js"></script>
<script src="scripts/conferences.js"></script>
<script src="libs/d3.slider.js"></script>
<script src="libs/d3.tip.v0.6.3.js"></script>
<link rel="stylesheet" href="libs/d3.slider.css" />
<style>
	.d3-tip {
		line-height:1;
		font-weight:bold;
		padding:12px;
		background: rgba(0,0,0,0.75);
		color:#fff;
		border-radius:5px;
	}

	body {
		font-family: sans-serif;
	}
    .axis path,
    .axis line {
        fill: none;
        stroke: lightgrey; 
    	stroke-width: 2px;
    }

    .axis text {
        font-family: sans-serif;
        font-size: 10pt;
    }

    .node {
    	clip-path: url(#clip);
    }

    .brush .extent {
    	stroke:black;
    	fill-opacity:0.125;
    	shape-rendering:crispEdges;
    }

    .brush .handle {
    	stroke:black;
    	fill-opacity:0.125;
    }
</style>
</head>
<body>
<table>
<tr>
<td colspan="2" align="center">
<h1>Exploring College Basketball's Top 25</h1>
</td>
</tr>
<tr>
<td rowspan="2">
<form>
<label><input type="radio" name="pollSelect" value="ap" id="radioap" onClick='displayPoll("AP")' checked> Associated Press</label>
<label><input type="radio" name="pollSelect" value="coaches" id="radiocoaches" onClick='displayPoll("coaches")'/> Coaches/USA Today</label>
&nbsp;&nbsp;
<select id="yearselect" autofocus>
	<option value="1980-81">1980-81</option>
	<option value="1981-82">1981-82</option>
	<option value="1982-83">1982-83</option>
	<option value="1983-84">1983-84</option>
	<option value="1984-85">1984-85</option>
	<option value="1985-86">1985-86</option>
	<option value="1986-87">1986-87</option>
	<option value="1987-88">1987-88</option>
	<option value="1988-89">1988-89</option>
	<option value="1989-90">1989-90</option>
	<option value="1990-91">1990-91</option>
	<option value="1991-92">1991-92</option>
	<option value="1992-93">1992-93</option>
	<option value="1993-94">1993-94</option>
	<option value="1994-95">1994-95</option>
	<option value="1995-96">1995-96</option>
	<option value="1996-97">1996-97</option>
	<option value="1997-98">1997-98</option>
	<option value="1998-99">1998-99</option>
	<option value="1999-00">1999-00</option>
	<option value="2000-01">2000-01</option>
	<option value="2001-02">2001-02</option>
	<option value="2002-03">2002-03</option>
	<option value="2003-04">2003-04</option>
	<option value="2004-05">2004-05</option>
	<option value="2005-06">2005-06</option>
	<option value="2006-07">2006-07</option>
	<option value="2007-08">2007-08</option>
	<option value="2008-09">2008-09</option>
	<option value="2009-10">2009-10</option>
	<option value="2010-11">2010-11</option>
	<option value="2011-12">2011-12</option>
	<option value="2012-13">2012-13</option>
	<option value="2013-14" selected>2013-14</option>
</select>
</form>
<div id="pollgraph"></div></td>
<td valign="top" align="center"><h3>Number of Ranked Teams Per Conference</h3><div id="confBar"></div></td>
</tr>
<tr>
<td valign="top" align="center"><h3>Biggest Weekly Movers<div id="movers"></div></td>
</tr>
</table>
<script type="text/javascript">

var mapteams = { 
				"Louisiana State": "LSU", 
				"St. John's (NY)": "St. John's", 
				"Southern California": "USC", 
				"Nevada-Las Vegas": "UNLV",
				"Texas-El Paso": "UTEP",
				"Central Florida": "UCF",
				"Alabama-Birmingham": "UAB",
				"College of Charleston": "Charleston",
				"Loyola (IL)": "Loyola Chicago",
				"Texas Christian": "TCU",
				"Mississippi": "Ole Miss"};

var margin = {
	top:10,
	right:150,
	bottom:50,
	left:30
};

var width1 = 1000 - margin.left - margin.right;

var bbPoll = {
	x: margin.left,
	y: margin.top,
	w: width1,
	h: 600
}

var dataset;
var teams = {};
var teamline;
var weeks = [];
var conferences = {};
var currentYear;
var currentPoll;
var maxRk;
var maxWk;
var allnodes;
var xsvg;
var brush;
var maxCount;

var confCanvas,chart;
var confXScale,confYScale,confXAxis,confXsvg;

var topMovers = {};

var pathHighlighted = 0;

origStroke = 2;
hoverStroke = 2;

var canvas = d3.select("#pollgraph").append("svg").attr({
	width: bbPoll.w + margin.left + margin.right,
	height: bbPoll.h + margin.top + margin.bottom
});

var svg = canvas.append("g").attr({
	transform: "translate(" + margin.left + "," + margin.top + ")"
	});

var polls = { "ap": "data/poll-data/2012-13-AP.csv", "coaches": "data/poll-data/2012-13-coaches.csv", "rpi": "data/rpi-ratings/2012-13-rpi.csv" };

var tip = d3.tip()
			.attr("class", "d3-tip")
			.offset([-10,0])
			.html(function(d) {
				friendly_full = getIDsBy(d).friendly_full;
				retVal = "";
				retVal += '<img src="data/logos/' + friendly_full + '.gif" width="75" height="50"/><br />' + friendly_full;
				return retVal;
			})

var nodetip = d3.tip()
				.attr("class", "d3-tip")
				.offset([-10,0])
				.html(function(d) {
					friendly_full = getIDsBy(undefined,undefined,undefined,d.School,undefined).friendly_full;
					retVal = "";
					retVal += '<img src="data/logos/' + friendly_full + '.gif" width="75" height="50" /><br />' + friendly_full;
					retVal += "<br />Week: " + d.Wk + ", Rank: " + d.Rk;
					return retVal;
				})

var conftip = d3.tip()
				.attr("class", "d3-tip")
				.direction('w')
				.offset(function(d) {
					if (d.count > (maxCount / 2)) {
						return [0,0];
					} else {
						return [0,0];
					}
				})
				.html(function(d) {
					retVal = "";
					schools = d.schools;
					confFull = getFullConference(d.conf);
					retVal += '<p style="text-align:center;"><span style="text-decoration:underline;">' + confFull + "</span><br />";
					schools.forEach(function(school) {
						retVal += school + "<br />";
					})
					return retVal;
				})

svg.call(tip);
svg.call(nodetip);

var externalschool;

var moversObj = {};

var missingCoaches = {
	"1992-93": 1,
	"1993-94": 1,
	"1994-95": 1,
	"1995-96": 1,
	"1996-97": 1,
	"1997-98": 1,
	"1998-99": 1,
	"1999-00": 1,
	"2000-01": 1,
	"2001-02": 1
}

function displayPoll(thePoll, year) {
	baseUrl = "data/poll-data/";
	if (thePoll === undefined) {
		thePoll = currentPoll;
	} else {
		currentPoll = thePoll;
	}
	if (year === undefined) {
		year = currentYear;
	} else {
		currentYear = year;
	}

	if (missingCoaches[year] === 1) {
		thePoll = "AP";
		currentPoll = thePoll;
		document.getElementById('radioap').checked = true;
	}
	thePollPath = baseUrl + year + "-" + thePoll + ".csv";

d3.csv(thePollPath, function(error, data) {
	teams = {};
	teamlines = [];
	weeks = [];
	conferences = {};
	dataset = data;
	maxRk = 0;
	allNodes = [];

	for (var i=0;i<dataset.length;i++) {
		if (dataset[i].Wk === "Wk") {
			dataset.splice(i,1);
		}
	}

	for (var i=0;i<dataset.length;i++) {
		line = dataset[i];
		school = line.School;
		strWeek = line.Wk;
		week = parseInt(strWeek);
		line.Wk = week;
		rank = parseInt(line.Rk);
		line.Rk = rank;
		starIndex = school.indexOf("*");
		if (weeks.indexOf(line.Wk) === -1) {
			weeks.push(line.Wk);
		}

		if (starIndex > 0) {
			school = school.substring(0,starIndex);
			line.School = school;
		} else if (/\sR/g.test(school)) {
			if (!/\sR[a-z]/g.test(school)) {
				lastIndex = school.lastIndexOf("R");
				school = school.substring(0,lastIndex-1);
				line.School = school;
			}
		} else if (/\sT/g.test(school)) {
			if (!/\sT[a-z]/g.test(school)) {
				lastIndex = school.lastIndexOf("T");
				school = school.substring(0,lastIndex-1);
				line.School = school;
			}
		}
		if (mapteams[school] !== undefined) {
			school = mapteams[school];
		}
		if (teams[school]) {
			teams[school].push(line);
		} else {
			teams[school] = [line];
		}

		conf = line.Conf;
		if (conferences[conf]) {
			if (conferences[conf][week]) {
				conferences[conf][week]["count"]++;
				conferences[conf][week]["schools"].push(school);
			} else {
				conferences[conf][week] = {"count": 1, "schools": [school]};
			}
		} else {
			conferences[conf] = {};
			conferences[conf][week] = {"count": 1, "schools": [school]};
		}

		// Find max rank
		if (line.Rk > maxRk) {
			maxRk = line.Rk;
		}
	}



	for (var school in teams) {
		rankedWeeks = [];
		ranks = teams[school];
		ranks.forEach(function(d) {
			rankedWeeks.push(d.Wk);
			espnid = getIDsBy(undefined,undefined,undefined,school,undefined).espn_id;
			allNodes.push({"School": school, "espnid": espnid, "Rk": d.Rk, "Wk": d.Wk});
		})
		//
		//  Change this for interpolation of missing ranks
		//
		if (rankedWeeks.length !== weeks.length) {
			var diff = [];
			var j=0;
			for (var i=0;i<weeks.length;i++) {
				if (rankedWeeks.indexOf(weeks[i]) === -1) {
					diff.push(weeks[i]);
				}
			}
			diff.forEach(function(d) {
				teams[school].push({"Wk": d, "Rk": (maxRk + 2)});
			})
		}
		ranks = teams[school];
		ranks.sort(function(a,b) {
			return d3.ascending(a.Wk, b.Wk);
		})
		// Build object with all rank changes keyed by week
		ranks.forEach(function(d, i) {
			if (i > 0) {
				change = ranks[i-1].Rk - ranks[i].Rk
				if (ranks[i-1].Rk === 27) change--;
				ranks[i].Chng = change;
				if (moversObj[d.Wk]) {
					moversObj[d.Wk].push({"School": school, "Change": change});
				} else {
					moversObj[d.Wk] = [{"School": school, "Change": change}];
				}
			}
		})
	}

	findTopMovers();

	maxWk = d3.max(weeks, function(d) { return d; });

	xscale = d3.scale.linear().domain([1,maxWk]).range([bbPoll.x,bbPoll.w-100]);
	brushscale = d3.scale.linear().domain([1,maxWk]).range([bbPoll.x,bbPoll.w-100]);
	yscale = d3.scale.linear().domain([1,maxRk + 1]).range([bbPoll.y+20,bbPoll.h]);

	xaxis = d3.svg.axis()
				.scale(xscale)
				.orient("bottom")
				.ticks(20);

	yaxis = d3.svg.axis()
				.scale(yscale)
				.orient("left")
				.ticks(25);

	teamline = d3.svg.line().x(function(d) { return xscale(d.Wk); })
								.y(function(d) { return yscale(d.Rk); })

	svg.selectAll("defs").remove();

    svg.append("defs").append("clipPath")
        .attr("id", "clip")
        .append("rect")
        .attr("width", (bbPoll.w-100)-bbPoll.x+5)
        .attr("height", bbPoll.h-10)
        .attr("x", bbPoll.x)
        .attr("y", bbPoll.y);

	count = 1;

	hideCircles();
	svg.selectAll('.teampath')
		.remove();
	svg.selectAll(".teamtext")
		.remove();
	svg.selectAll(".axis")
		.remove();
	svg.selectAll(".node")
		.remove();

	for (var school in teams) {
		espnid = getIDsBy(undefined,undefined,undefined,school,undefined).espn_id;
		espnid = "x" + espnid.toString();

		svg.append("g").classed("teampath", true).append("path")
			.attr("d", teamline(teams[school]))
			.classed(espnid, true)
			.classed("teampath", true)
			.style("fill", "none")
			.style("stroke-width", origStroke)
			.style("stroke", searchColor(school))
			.on("click", function(d) {
				var thePath = d3.select(this);
				theClass = getClassFromPath(thePath);
				showCircles(theClass,thePath);
			})
			.on("mouseover", function(d) {
				d3.select("body").style("cursor", "pointer");
			})
			.on("mouseout", function(d) {
				d3.select("body").style("cursor", "default");
			})
			.style("clip-path", "url(#clip)")
		count++;

		lastRk = teams[school][teams[school].length-1].Rk;
		if (lastRk < (maxRk + 2)) {
			svg.append("text")
				.classed("teamtext", true)
				.attr("transform", "translate("+(bbPoll.w-90)+","+yscale(lastRk)+")")
				.attr("dy", ".25em")
				.attr("text-anchor", "start")
				.style("fill", searchColor(school))
				.text(lastRk + ": " + school);
		}

	}

	nodes = svg.selectAll(".node")
				.data(allNodes)
				.enter()
				.append("g")
				.classed("node", true)
				.append("circle")
					.attr("r", 5)
					.attr("fill", function(d) { return searchColor(d.School); })
					.style("display", "none")
					.attr("class", function(d) { return "x" + d.espnid + " circ"; })
					.attr("transform", function(d) {
						return "translate("+xscale(d.Wk)+","+yscale(d.Rk)+")";
					})
					.on("mouseover", function(d) {
						nodetip.show(d);
					})
					.on("mouseout", function(d) {
						nodetip.hide(d);
					})

	if (brush !== undefined) {
		d3.selectAll(".brush").call(brush.clear());
	}
	brush = d3.svg.brush().x(brushscale).on("brush", brushed);


	be1 = svg.append("g").attr("class", "brush").call(brush);
	be1.selectAll("rect")
		.attr("y", 600)
		.attr("height", 23);


	xsvg = svg.append("g")
		.attr("class", "axis")
		.attr("transform", "translate(0,600)")
		.call(xaxis)
		.selectAll("text")
			.attr("class", "xaxis-label")
			.on("mouseover", function() {
				d3.select("body").style("cursor", "pointer");
			})
			.on("mouseout", function() {
				d3.select("body").style("cursor", "default");
			})
			.on("click", function(d) {
				updateConfBar(d);
				d3.selectAll(".xaxis-label").style("font-weight", "normal");
				d3.select(this).style("font-weight", "bold");
				return updateMoversTable(d);
			})

	svg.append("text")
		.attr("transform", "translate(360,640)")
		.style("text-anchor", "middle")
		.text("Week");

	svg.append("g")
		.attr("class", "axis")
		.attr("transform", "translate("+margin.left+",0)")
		.call(yaxis);

	svg.append("text")
		.attr("transform", "translate(0,300) rotate(-90)")
		.style("text-anchor", "middle")
		.text("Rank");

	updateMoversTable(1);
	updateConfBar(1);

}) // end d3.csv
} // end function

var allPaths;

function brushed() {
	if (!d3.event.sourceEvent) return;

	var extent0 = brush.extent(),
		extent1 = extent0.map(function(d) { return Math.round(d); });

	if (extent1[0] > extent1[1]) {
		extent1[0] = Math.floor(extent0[0]);
		extent1[1] = Math.ceil(extent0[1]);
	}

	d3.select(this).transition()
		.call(brush.extent(extent1))
		.call(brush.event);
	xscale.domain(brush.empty() ? brushscale.domain(): brush.extent());

	svg.selectAll(".teamtext")
			.remove();
	for (var school in teams) {
		espnid = getIDsBy(undefined,undefined,undefined,school).espn_id;
		svg.select("path.x"+espnid).attr("d", teamline(teams[school]));

		lastRk = teams[school][extent1[1]-1].Rk;
		if (lastRk < (maxRk + 2)) {
			svg.append("text")
				.classed("teamtext", true)
				.attr("transform", "translate("+(bbPoll.w-90)+","+yscale(lastRk)+")")
				.attr("dy", ".25em")
				.attr("text-anchor", "start")
				.style("fill", searchColor(school))
				.text(lastRk + ": " + school);
		}
	}
	svg.selectAll(".circ").attr("transform", function(d) { return "translate("+xscale(d.Wk) + "," + yscale(d.Rk) + ")"; })
}

function getClassFromPath(thePath) {
	theClass = thePath[0][0].className.animVal;
	tpi = theClass.indexOf("teampath");
	theClass = theClass.substring(1,(tpi-1));
	return theClass;
}

function highlightPath(thePath,school) {

	d3.selectAll("path.teampath")
			.style("opacity", 0.25)
			.style("stroke-width", 1);

	if (thePath) {
		thePath.style("stroke-width", hoverStroke)
				.style("opacity", 1);
	}
	if (school) {
		school = getIDsBy(undefined,undefined,undefined,school,undefined).espn_id;
		school = "x" + school.toString();
		thePath = d3.select("path."+school);
		thePath.style("stroke-width", hoverStroke)
				.style("opacity", 1);
	}
}

function showCircles(espnid,thePath) {
	if (pathHighlighted === 0) {
		highlightPath(thePath);
		d3.selectAll("circle.x"+espnid)
			.style("display", "block");
		pathHighlighted = espnid;
	} else if (pathHighlighted === espnid) {
		d3.selectAll("circle.x"+espnid)
			.style("display", "none");
		backToNormal();
		pathHighlighted = 0;
	} else if (pathHighlighted > 0) {
		console.log(espnid, pathHighlighted);
		d3.selectAll("circle.x"+pathHighlighted)
			.style("display", "none");
		d3.selectAll("circle.x"+espnid)
			.style("display", "block");
		backToNormal();
		highlightPath(thePath);
		pathHighlighted = espnid;
	}
}

function hideCircles() {
	d3.selectAll("circle.x"+pathHighlighted)
		.style("display", "none");
	pathHighlighted = 0;
}


function findTopMovers() {
	for (var week in moversObj) {
		changes = moversObj[week];
		changes.sort(function(a,b) {
			return d3.descending(Math.abs(a.Change), Math.abs(b.Change));
		})
		topM = changes.splice(0,7);
		topM.sort(function(a,b) {
			return d3.descending(a.Change, b.Change);
		})
		topMovers[week] = topM;
	}
}

var moversTable, moversThead, moversTbody, moversRows, moversColumns, moversCells;

function createMoversTable() {
	moversColumns = ["School", "Change"];
	var dummydata = [];
	for (var i=0;i<7;i++) {
		dummydata.push({"School": i, "Change": i});
	}

	moversTable = d3.select("#movers").append("table")
					.style("display", "none")
					.attr("width", "300px")
					.attr("height", "300px");

	moversThead = moversTable.append("thead");
	moversTbody = moversTable.append("tbody");

	moversThead.append("tr")
			.selectAll("th")
			.data(moversColumns)
			.enter()
			.append("th")
				.text(function(column) { return column; })
				.attr("align", function(d,i) { return i===0?"left":"center"; })
				.attr("width", function(d,i) { return i===0?"200px":"100px"; })

	moversRows = moversTbody.selectAll("tr")
				.data(dummydata)
				.enter()
				.append("tr");

	return moversTable;
}

function updateMoversTable(week) {
	var moversData = topMovers[week];

	moversTable.style("display", "block");

	moversTbody.selectAll("tr").remove();

	if (moversData !== undefined) {

		moversRows = moversTbody.selectAll("tr")
					.data(moversData)
					.enter()
					.append("tr");

		moversCells = moversRows.selectAll("td")
					.data(function(row) {
						return moversColumns.map(function(column) {
							return {column: column, value: row[column]};
						})
					})
					.enter()
					.append("td")
						.html(function(d) { return d.value; })
						.attr("align", function(d,i) { return i===0?"left":"center"; })
	} else {
		moversRows = moversTbody.selectAll("tr")
						.data([1])
						.enter()
						.append("tr");

		moversCells = moversRows.selectAll("td")
					.data(["No changes in first week of season"])
					.enter()
					.append("td")
						.html(function(d) { return d; })
						.attr("colspan", 2);
	}
}

function createConfBar() {
	confCanvas = d3.select("#confBar").append("svg").attr({
		width: 400,
		height: 300
	})

	chart = confCanvas.append("g").attr({
		transform: "translate(0,20)"
	});

	confXScale = d3.scale.ordinal().rangeRoundBands([0,400]);
	confYScale = d3.scale.linear().rangeRound([250,0]);

	confXAxis = d3.svg.axis()
					.scale(confXScale)
					.orient("bottom");

	confXsvg = chart.append("g")
					.attr("class", "axis")
					.attr("transform", "translate(0,250)");

	chart.call(conftip);

}

var currConfs,confCounts;
function updateConfBar(week) {
	currConfs = [];
	confCounts = [];
	for (var conf in conferences) {
		if (conferences[conf][week]) {
			currConfs.push(conf);
			theConfObj = conferences[conf][week];
			theConfObj["conf"] = conf;
			confCounts.push(theConfObj);
		}
	}


	confXScale.domain(currConfs);
	confXsvg.call(confXAxis)
		.selectAll("text")
			.style("font-size", "7pt");
	maxCount = d3.max(confCounts, function(d) { return d.count; });
	confYScale.domain([0,maxCount]);

	chart.selectAll("rect").remove();
	chart.selectAll(".barValue").remove();

	chart.selectAll("rect")
			.data(confCounts)
			.enter()
			.append("rect")
			.attr("class", "bars")
			.attr("fill", "lightsteelblue")
			.attr("height", function(d) { return (250-confYScale(d.count)); })
			.attr("width", ((400/confCounts.length)-2))
			.attr("transform", function(d,i) { return "translate(" + confXScale(currConfs[i]) + "," + confYScale(d.count) + ")"; })
			.on("mouseover", function(d) {
				conftip.show(d);
			})
			.on("mouseout", function(d) {
				conftip.hide(d);
			})

	chart.selectAll(".barValue")
			.data(confCounts)
			.enter()
			.append("text")
			.text(function(d) {
				return d.count;
			})
			.attr("class", "barValue")
			.attr("text-anchor", "middle")
			.attr("x", function(d, i) {
				return i * (400 /confCounts.length) + (400 / confCounts.length - 2) /2;
			})
			.attr("y", function(d) {
				return (confYScale(d.count) + 24);
			})
			.on("mouseover", function(d) {
				conftip.show(d);
			})
			.on("mouseout", function(d) {
				conftip.hide(d);
			})
}

function backToNormal() {
	d3.selectAll("path.teampath")
					.style("opacity", 1)
					.style("stroke-width", origStroke);
}

d3.select("#yearselect").on("change", change)
function change() {
	displayPoll(undefined,d3.select("#yearselect").property("value"));
}

createConfBar();
createMoversTable();
displayPoll("AP", "2013-14");



</script>

</body>
</html>
